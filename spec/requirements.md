# 要件定義

## 1. 機能要件

### 1.1 LINE Bot連携機能

- FR-LINE-001: Webhookエンドポイント
    - LINE Messaging APIからのWebhookイベントを受信するエンドポイントを提供する
    - HTTPSでのリクエストを受け付ける
- FR-LINE-002: 署名検証
    - LINE Messaging APIからのリクエストに含まれる署名を検証する
    - 署名が不正な場合は401/403エラーを返す
- FR-LINE-003: メッセージイベント処理
    - テキストメッセージイベントを解析する
    - コマンドと質問メッセージを識別する
- FR-LINE-004: メッセージ返信
    - LINE Messaging APIを使用してユーザーにメッセージを返信する
    - Reply APIを使用して応答する
- FR-LINE-005: 長文メッセージ対応
    - LINEのメッセージ長制限（5000文字）を超える場合は分割して送信する
    - 分割の理由: 情報の欠落を防ぎ、ユーザーが必要な情報を確実に得られるようにするため
- FR-LINE-006: 返信エラーリトライ
    - LINE APIへの送信失敗時にリトライ処理を行う
    - エラーをログに記録する

### 1.2 ドキュメント同期機能

- FR-SYNC-001: 同期コマンド受付
    - "sync" メッセージを同期コマンドとして認識する
    - コマンド受信時に開始メッセージを返信する
- FR-SYNC-002: ドキュメント一覧取得
    - 設定されたAPIエンドポイントからドキュメント一覧を取得する
- FR-SYNC-003: ページネーション対応（オフセット）
    - オフセットベースのページネーションに対応する
    - 全ページを順次取得する
- FR-SYNC-004: ページネーション対応（カーソル）
    - カーソルベースのページネーションに対応する
    - カーソルがなくなるまで全ページを取得する
- FR-SYNC-005: ドキュメント内容取得
    - ドキュメント一覧から各ドキュメントの内容を取得する
- FR-SYNC-006: 同期完了通知
    - 同期処理完了時に完了メッセージを返信する
- FR-SYNC-007: 部分的成功対応
    - 一部のドキュメント取得に失敗した場合、取得できたドキュメントのみでインデックスを更新する
    - 部分的成功メッセージを返信する

### 1.3 ドキュメントパース機能

- FR-PARSE-001: JSON形式パース
    - JSON形式のドキュメントをパースする
    - 設定されたフィールド名でタイトル・本文を抽出する
- FR-PARSE-002: JSON階層構造対応
    - ネストされたJSONフィールドからデータを抽出する
    - ドット記法（例: `data.article.title`）でパスを指定できる
- FR-PARSE-003: HTML形式パース
    - HTML形式のドキュメントをパースする
    - CSSセレクタでタイトル・本文を抽出する
    - HTMLタグを除去してテキストを取得する
- FR-PARSE-004: プレーンテキスト形式パース
    - プレーンテキスト形式のドキュメントを処理する
    - テキスト全体を本文として使用する
- FR-PARSE-005: パースエラー処理
    - パース処理でエラーが発生した場合、該当ドキュメントをスキップする
    - エラーをログに記録する
    - 他のドキュメントの処理を継続する

### 1.4 インデックス管理機能

- FR-INDEX-001: インデックス構築
    - パースしたドキュメントからベクトルインデックスを構築する
- FR-INDEX-002: インデックス更新
    - 同期処理時にインデックスを更新する
- FR-INDEX-003: インデックス存在確認
    - インデックスが構築済みかどうかを確認する

### 1.5 ステータス確認機能

- FR-STATUS-001: ステータスコマンド受付
    - "status" メッセージをステータス確認コマンドとして認識する
- FR-STATUS-002: インデックスステータス取得
    - インデックスが利用可能かどうかを取得する
- FR-STATUS-003: ステータスメッセージ返信
    - 取得したステータス情報をユーザーに返信する
    - インデックス未構築の場合は同期を促すメッセージを含める

### 1.6 質問応答機能

- FR-QA-001: 質問メッセージ受付
    - コマンド以外のメッセージを質問として処理する
- FR-QA-002: RAG検索
    - インデックスから質問に関連するドキュメントを検索する
- FR-QA-003: 複数ドキュメント統合
    - 複数の関連ドキュメントを取得した場合、情報を統合する
- FR-QA-004: LLM回答生成
    - 取得したドキュメントと質問をもとにLLMで回答を生成する
- FR-QA-005: 回答返信
    - 生成した回答をユーザーに返信する
- FR-QA-006: 関連ドキュメントなし対応
    - 関連ドキュメントが見つからない場合、適切なメッセージを返信する
- FR-QA-007: インデックス未構築対応
    - インデックスが構築されていない場合、同期を促すメッセージを返信する

## 2. 非機能要件

### 2.1 エラーハンドリング

- NFR-ERR-001: API接続エラー
    - 外部APIへの接続失敗時に適切なエラーメッセージを返信する
- NFR-ERR-002: インデックス更新エラー
    - インデックス更新失敗時にエラーメッセージを返信する
- NFR-ERR-003: RAG検索エラー
    - RAG検索処理のエラー時にエラーメッセージを返信する
- NFR-ERR-004: LLM回答生成エラー
    - LLMでの回答生成失敗時にエラーメッセージを返信する
- NFR-ERR-005: エラーログ記録
    - すべてのエラーをログに記録する

### 2.2 設定管理

- NFR-CFG-001: APIエンドポイント設定
    - ドキュメント取得用のAPIエンドポイントを設定できる
- NFR-CFG-002: 認証情報設定
    - LINE Messaging APIのチャネルシークレット・アクセストークンを設定できる
- NFR-CFG-003: ドキュメント形式設定
    - ドキュメントの形式（JSON/HTML/プレーンテキスト）を設定できる
- NFR-CFG-004: フィールドマッピング設定
    - JSONフィールド名やCSSセレクタを設定できる
- NFR-CFG-005: ページネーション設定
    - ページネーション方式（オフセット/カーソル）を設定できる

### 2.3 セキュリティ

- NFR-SEC-001: 署名検証必須
    - すべてのWebhookリクエストで署名検証を行う
- NFR-SEC-002: 認証情報の安全な管理
    - APIキーやトークンを環境変数で管理する

### 2.4 信頼性

- NFR-REL-001: 部分的失敗の継続処理
    - 一部の処理が失敗しても、他の処理を継続する
- NFR-REL-002: リトライ機能
    - 一時的なエラーに対してリトライ処理を行う
    - 指数バックオフによる再試行を実装する
    - LINE API、DocumentSource、IndexBuilderでリトライを実装
    - デフォルト設定: 最大3回、初回1000ms、exponential backoff (1s → 2s → 4s)
- NFR-REL-003: レート制限
    - 外部APIへのリクエスト間に待機時間を設定できる
    - 大量処理時のAPI過負荷を防止する

## 3. データ要件

### 3.1 ドキュメントデータ

- DR-DOC-001: ドキュメント構造
    - タイトル（文字列）
    - 本文（文字列）
    - メタデータ（任意）

### 3.2 インデックスデータ

- DR-IDX-001: ベクトルインデックス
    - ドキュメントのベクトル表現を保存する
    - 類似検索が可能な形式で保存する

## 4. 外部インターフェース要件

### 4.1 LINE Messaging API

- EI-LINE-001: Webhook受信
    - POST /webhook エンドポイントでイベントを受信する
- EI-LINE-002: Reply API
    - メッセージ返信にReply APIを使用する

### 4.2 ドキュメントAPI

- EI-DOC-001: ドキュメント一覧API
    - ドキュメント一覧を取得するAPIに対応する
    - ページネーションに対応する
- EI-DOC-002: ドキュメント内容API
    - 個別のドキュメント内容を取得するAPIに対応する

### 4.3 LLM API

- EI-LLM-001: テキスト生成API
    - LLMを使用して回答を生成する
