# ユースケース

## 概要

このドキュメントでは、各シナリオを実現するために必要なユースケース（アプリケーションサービス）を定義する。

## 設計方針

- **ユースケースは独立した単位**として設計し、ユースケース間の依存を避ける
- **Webhookイベントの処理**はプレゼンテーション層（ルーター/コントローラー）の責務とする
- **メッセージの返信**はポート/アダプターとして扱い、各ユースケースから利用する

## 1. ドキュメント同期ユースケース

### UC-SYNC-001: ドキュメントを同期する

- **概要**: 外部APIからドキュメントを取得し、インデックスを更新する
- **アクター**: ユーザー（syncコマンド経由）
- **事前条件**: APIエンドポイントが設定されている
- **事後条件**: インデックスが最新のドキュメントで更新される
- **主要フロー**:
    1. 同期開始メッセージを返信する
    2. ドキュメント一覧を取得する（ページネーション対応）
    3. 各ドキュメントの内容を取得する
    4. ドキュメントをパースする
    5. インデックスを更新する
    6. 同期完了メッセージを返信する
- **代替フロー**:
    - API接続エラー: エラーメッセージを返信する
    - 一部ドキュメント取得失敗: 取得できたドキュメントのみで処理を継続し、部分的成功メッセージを返信する
    - パースエラー: 該当ドキュメントをスキップし、エラーをログに記録する
    - インデックス更新エラー: エラーメッセージを返信する
- **関連シナリオ**: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 3.1, 3.2, 3.3, 3.4, 3.5
- **関連要件**: FR-SYNC-001〜007, FR-PARSE-001〜005, FR-INDEX-001, FR-INDEX-002, NFR-ERR-001, NFR-ERR-002, NFR-REL-001

## 2. 質問応答ユースケース

### UC-QA-001: 質問に回答する

- **概要**: ユーザーの質問に対してRAGを使用して回答を生成する
- **アクター**: ユーザー（質問メッセージ経由）
- **事前条件**: なし
- **事後条件**: ユーザーに回答が返信される
- **主要フロー**:
    1. インデックスの存在を確認する
    2. RAGでインデックスを検索し、関連ドキュメントを取得する
    3. 取得したドキュメントと質問をもとにLLMで回答を生成する
    4. 回答を返信する
- **代替フロー**:
    - インデックス未構築: 同期を促すメッセージを返信する
    - 関連ドキュメントなし: 適切なメッセージを返信する
    - RAG検索エラー: エラーメッセージを返信する
    - LLM回答生成エラー: エラーメッセージを返信する
- **関連シナリオ**: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6
- **関連要件**: FR-QA-001〜007, FR-INDEX-003, NFR-ERR-003, NFR-ERR-004

## 3. ユースケース関連図

```
┌─────────────────────────────────────────────────────────────┐
│                      LINE Messaging API                       │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
                 ┌────────────────────────┐
                 │  プレゼンテーション層    │
                 │  (Webhook Handler)     │
                 │  - 署名検証            │
                 │  - イベント解析         │
                 │  - コマンド/質問判定    │
                 └────────────┬───────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌──────────────────┐            ┌──────────────────┐
    │  UC-SYNC-001     │            │  UC-QA-001       │
    │  ドキュメントを   │            │  質問に回答する   │
    │  同期する        │            │                  │
    └────────┬─────────┘            └────────┬─────────┘
             │                               │
             │    ┌─────────────────┐        │
             └───►│ LineMessaging   │◄───────┘
                  │ Port            │
                  │ (メッセージ返信) │
                  └─────────────────┘
```

## 4. ユースケースとドメインの対応

| ユースケース | ドメイン |
|------------|---------|
| UC-SYNC-001 | sync |
| UC-QA-001 | qa |

## 5. ユースケースが使用するポート

### UC-SYNC-001: ドキュメントを同期する

- `DocumentApiPort`: ドキュメント一覧取得、ドキュメント内容取得
- `DocumentParserPort`: ドキュメントのパース
- `IndexPort`: インデックス更新
- `LineMessagingPort`: メッセージ返信

### UC-QA-001: 質問に回答する

- `IndexPort`: インデックス存在確認、類似検索
- `LlmPort`: 回答生成
- `LineMessagingPort`: メッセージ返信

## 6. プレゼンテーション層の責務

以下はユースケースではなく、プレゼンテーション層（ルーター/コントローラー）で処理する：

- **Webhookイベント受信**: LINE Messaging APIからのリクエスト受信
- **署名検証**: リクエストの正当性確認（FR-LINE-002, NFR-SEC-001）
- **イベント解析**: メッセージイベントの解析（FR-LINE-003）
- **コマンド判定**: syncコマンドと質問メッセージの識別
- **ユースケース呼び出し**: 適切なユースケースへの振り分け
