# ドメイン設計

## ドメイン区分

本システムは以下の4つのドメインで構成される。

### 1. Message

LINEメッセージングに関するドメイン。Webhookイベントの受信、メッセージの解析、返信メッセージの送信を担当する。

- **責務**: メッセージの受信・送信・解析
- **主要な関心事**: LINE Messaging APIとの連携、コマンド識別、メッセージ長制限対応

### 2. Document

ドキュメントの取得とパースに関するドメイン。外部APIからのドキュメント取得、各種形式のパース処理を担当する。

- **責務**: ドキュメントの取得・パース・構造化
- **主要な関心事**: API連携、ページネーション、形式変換（JSON/HTML/テキスト）

### 3. VectorIndex

ベクトルインデックスの管理に関するドメイン。ドキュメントのインデックス構築、更新、検索を担当する。

- **責務**: インデックスの構築・更新・検索
- **主要な関心事**: ベクトル化、類似検索、インデックス永続化

### 4. Answer

質問応答に関するドメイン。RAG検索と LLM による回答生成を担当する。

- **責務**: 質問に対する回答の生成
- **主要な関心事**: 関連ドキュメント検索、コンテキスト構築、LLM回答生成

## ドメイン間の依存関係

```
┌─────────┐     ┌─────────┐     ┌──────────┐
│ Message │     │ Answer  │     │ Document │
└─────────┘     └────┬────┘     └────┬─────┘
                     │               │
                     │ uses          │ uses
                     ▼               ▼
               ┌─────────────────────────┐
               │      VectorIndex        │
               └─────────────────────────┘
```

### 依存関係の説明

1. **Answer → VectorIndex**: 回答生成時にインデックスから関連ドキュメントを検索する
2. **VectorIndex → Document**: 論理的な依存関係。実際のデータフローはアプリケーション層が制御する

### アプリケーション設定について

アプリケーション設定はドメインとして定義せず、以下の方式で管理する。

**設定の読み込みフロー**:
1. 環境変数から設定値を読み込む（`src/config.ts`）
2. Zodでバリデーションし、型安全な設定オブジェクトを生成
3. DIコンテナ（Context）生成時に設定オブジェクトを参照
4. 各アダプターのコンストラクタに必要な設定値を注入

**設計原則**:
- 設定はドメイン間の依存関係に含まれない
- ドメイン層は設定への直接的な依存を持たない
- 設定値は定数として扱い、アプリケーション起動時に一度だけ読み込む
- 各アダプターは必要な設定のみを受け取る（最小知識の原則）

**注入先の例**:
- `DocumentListFetcher`: APIエンドポイント、認証情報
- `DocumentParser`: パース設定（ParserConfig）
- `EmbeddingGenerator`: モデル名、APIキー
- `AnswerGenerator`: モデル名、APIキー、プロンプト設定
- `MessageSender`: LINEチャネルアクセストークン

**BuildVectorIndexの入力データ取得について**:

BuildVectorIndexユースケースの入力は`Document[]`であるが、VectorIndexドメイン内ではDocumentRepositoryへの直接参照は行わない。

この設計により:
- ドメイン間の結合度を低く保つ
- 各ドメインの責務が明確になる
- テストが容易になる

### アーキテクチャレイヤーの責務

```
┌─────────────────────────────────────────┐
│        Presentation Layer               │
│  (Webhook Handler / API Handler)        │
├─────────────────────────────────────────┤
│  - HTTPリクエストの受信                   │
│  - 署名検証・入力バリデーション             │
│  - コマンドの識別・ルーティング             │
│  - 適切なユースケースの呼び出し             │
│  - HTTPレスポンスの返却                   │
└────────────┬────────────────────────────┘
             │ calls
             ▼
┌─────────────────────────────────────────┐
│        Application Layer                │
│  (Use Cases / Orchestration)            │
├─────────────────────────────────────────┤
│  - ドメイン間のオーケストレーション         │
│  - トランザクション境界の管理              │
│  - ワークフローの制御                     │
└────────────┬────────────────────────────┘
             │ calls
    ┌────────┼────────┬────────┐
    ▼        ▼        ▼        ▼
┌────────┐┌──────┐┌────────┐┌───────────┐
│Message ││Answer││Document││VectorIndex│
│ Domain ││Domain││ Domain ││  Domain   │
└────────┘└──────┘└────────┘└───────────┘
```

### アプリケーション層のユースケース

ドメイン間を跨ぐオーケストレーションは**アプリケーション層**が担当する。

**階層関係の明確化**:

- **アプリケーション層ユースケース**（usecases.mdのUC-SYNC-001, UC-QA-001, UC-STATUS-001）
  - システム全体のユースケースを定義
  - 複数ドメインのオーケストレーションを行う
  - トランザクション境界を管理
  - **ポートを利用（呼び出し）する**

- **ドメイン層**
  - エンティティ・値オブジェクト
  - ドメインサービス（純粋なビジネスロジックのみ）
  - **ポートのインターフェースを定義（副作用の抽象化を提供）**

**DDDの原則**:
- ドメイン層に「ユースケース」は存在しない
- 簡単なビジネスロジックは集約のメソッドに配置
- 複雑なビジネスロジックはドメインサービスに配置（ただしポート呼び出しは行わない）
- **ポートの利用（副作用を伴う処理）はアプリケーション層で実行**
- ドメインサービスは純粋関数として実装し、必要なデータは引数で受け取る

ユースケースの詳細（処理フロー、エラーハンドリング等）は [usecases.md](../usecases.md) を参照。

## 設計上の制約

### 単一テナント前提

**重要**: 現在の設計は**単一テナント（単一Botインスタンス）**を前提としている。

#### 現在の設計

- 全ユーザーが同一のドキュメントセットとインデックスを共有
- ユーザーごとのドキュメント管理やアクセス制御は行わない
- 1つのLINE公式アカウントに対して1つのBotインスタンスを想定

#### 将来の拡張（マルチテナント対応）

マルチテナント対応が必要になった場合は、以下の変更が必要:

1. **テナントIDの追加**:
   - 全テーブルに`tenant_id`カラムを追加
   - `documents`, `vector_index_entries`, `answers`, `answer_sources`

2. **ドメインモデルの変更**:
   - 各エンティティに`tenantId`を追加
   - リポジトリ/ポートのメソッドにテナントIDを引数として追加

3. **認証・認可の追加**:
   - 設定にテナント認証設定を追加
   - プレゼンテーション層でテナント識別ロジックを実装

**優先度**: 現時点では対応不要。実際の要件が発生した時点で設計を拡張する。

## 各ドメインの詳細

- [Message](./message.md)
- [Document](./document.md)
- [VectorIndex](./vectorIndex.md)
- [Answer](./answer.md)

## 共通型定義

- [Shared](./shared.md) - 複数ドメインで共有する値オブジェクト（DocumentId, SimilarityScore）
