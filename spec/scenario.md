# シナリオ

## 1. ドキュメント同期シナリオ

### 1.1 同期コマンド送信（正常系）

- **前提条件**: ユーザーがLINE Botと友達登録済み、APIエンドポイントが正しく設定されている
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. LINE Botがメッセージを受信
    2. 「同期を開始しました」等のメッセージをユーザーに返信
    3. コマンドを解析し、同期処理を開始
    4. 設定されたAPIからドキュメント一覧を取得
    5. 各ドキュメントの内容を取得
    6. ドキュメントをパースして構造化
    7. インデックスを更新
    8. 完了メッセージをユーザーに返信
- **期待結果**: 「同期が完了しました」等のメッセージが返信される

### 1.2 同期コマンド送信（API接続エラー）

- **前提条件**: APIエンドポイントが不正または接続不可
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. LINE Botがメッセージを受信
    2. 「同期を開始しました」等のメッセージをユーザーに返信
    3. コマンドを解析し、同期処理を開始
    4. APIへの接続に失敗
    5. エラーメッセージをユーザーに返信
- **期待結果**: 「同期に失敗しました」等のエラーメッセージが返信される

### 1.3 同期コマンド送信（ドキュメント取得エラー）

- **前提条件**: 一部のドキュメントが取得できない状態
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. ドキュメント一覧を取得
    2. 一部のドキュメント内容取得に失敗
    3. 取得できたドキュメントのみでインデックスを更新
    4. 部分的成功メッセージをユーザーに返信
- **期待結果**: 「一部のドキュメントの同期に失敗しました」等のメッセージが返信される

### 1.4 同期コマンド送信（インデックス更新エラー）

- **前提条件**: インデックス更新処理でエラーが発生
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. ドキュメントを正常に取得
    2. インデックス更新処理でエラーが発生
    3. エラーメッセージをユーザーに返信
- **期待結果**: 「インデックスの更新に失敗しました」等のエラーメッセージが返信される

### 1.5 同期コマンド送信（ページネーション - オフセット）

- **前提条件**: ドキュメント一覧APIがオフセットベースのページネーションを使用
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. 最初のページを取得（offset=0）
    2. 次のページがある場合、オフセットを増加させて繰り返し取得
    3. 全ページ取得完了後、インデックスを更新
- **期待結果**: 全ドキュメントが取得され、インデックスが更新される

### 1.6 同期コマンド送信（ページネーション - カーソル）

- **前提条件**: ドキュメント一覧APIがカーソルベースのページネーションを使用
- **トリガー**: ユーザーが "sync" とメッセージを送信
- **処理フロー**:
    1. 最初のページを取得
    2. レスポンスに含まれるカーソルを使用して次のページを取得
    3. カーソルがなくなるまで繰り返し
    4. 全ページ取得完了後、インデックスを更新
- **期待結果**: 全ドキュメントが取得され、インデックスが更新される

### 1.7 ステータス確認コマンド送信（正常系）

- **前提条件**: インデックスが構築済み
- **トリガー**: ユーザーが "status" とメッセージを送信
- **処理フロー**:
    1. LINE Botがメッセージを受信
    2. コマンドを解析し、ステータス取得処理を開始
    3. インデックスの状態を取得（ドキュメント数、エントリ数、最終更新日時）
    4. ステータス情報をユーザーに返信
- **期待結果**: インデックスの状態情報が返信される

### 1.8 ステータス確認コマンド送信（インデックス未構築）

- **前提条件**: インデックスが構築されていない
- **トリガー**: ユーザーが "status" とメッセージを送信
- **処理フロー**:
    1. LINE Botがメッセージを受信
    2. コマンドを解析し、ステータス取得処理を開始
    3. インデックスが存在しないことを検知
    4. 未構築を示すメッセージをユーザーに返信
- **期待結果**: 「インデックスが構築されていません」等のメッセージが返信される

## 2. 質問応答シナリオ

### 2.1 質問メッセージ送信（正常系）

- **前提条件**: インデックスが構築済み
- **トリガー**: ユーザーがコマンド以外のメッセージを送信
- **処理フロー**:
    1. LINE Botがメッセージを受信
    2. メッセージがコマンドでないことを確認
    3. RAGでインデックスを検索
    4. 関連ドキュメントを取得
    5. LLMで回答を生成
    6. 回答をユーザーに返信
- **期待結果**: ドキュメントに基づいた回答が返信される

### 2.2 質問メッセージ送信（関連ドキュメントなし）

- **前提条件**: インデックスが構築済みだが、質問に関連するドキュメントがない
- **トリガー**: ユーザーが質問メッセージを送信
- **処理フロー**:
    1. RAGでインデックスを検索
    2. 関連ドキュメントが見つからない
    3. 適切なメッセージを生成して返信
- **期待結果**: 「該当する情報が見つかりませんでした」等のメッセージが返信される

### 2.3 質問メッセージ送信（インデックス未構築）

- **前提条件**: インデックスが構築されていない
- **トリガー**: ユーザーが質問メッセージを送信
- **処理フロー**:
    1. インデックスが存在しないことを検知
    2. 同期を促すメッセージをユーザーに返信
- **期待結果**: 「先に sync コマンドを実行してください」等のメッセージが返信される

### 2.4 質問メッセージ送信（RAG検索エラー）

- **前提条件**: RAGサービスでエラーが発生
- **トリガー**: ユーザーが質問メッセージを送信
- **処理フロー**:
    1. RAG検索処理でエラーが発生
    2. エラーメッセージをユーザーに返信
- **期待結果**: 「回答の生成に失敗しました」等のエラーメッセージが返信される

### 2.5 質問メッセージ送信（LLM回答生成エラー）

- **前提条件**: LLMサービスでエラーが発生
- **トリガー**: ユーザーが質問メッセージを送信
- **処理フロー**:
    1. 関連ドキュメントを正常に取得
    2. LLMでの回答生成に失敗
    3. エラーメッセージをユーザーに返信
- **期待結果**: 「回答の生成に失敗しました」等のエラーメッセージが返信される

### 2.6 質問メッセージ送信（複数の関連ドキュメント）

- **前提条件**: 質問に関連する複数のドキュメントが存在
- **トリガー**: ユーザーが質問メッセージを送信
- **処理フロー**:
    1. RAGで複数の関連ドキュメントを取得
    2. 複数ドキュメントの情報を統合して回答を生成
    3. 回答をユーザーに返信
- **期待結果**: 複数ドキュメントの情報を統合した回答が返信される

## 3. ドキュメント形式別シナリオ

### 3.1 JSON形式ドキュメントの取得

- **前提条件**: ドキュメントAPIがJSON形式でレスポンスを返す
- **トリガー**: 同期処理中にドキュメントを取得
- **処理フロー**:
    1. APIからJSONレスポンスを取得
    2. 設定されたフィールド名でタイトル・本文を抽出
    3. 階層構造の場合はネストされたフィールドを辿る
    4. 抽出したデータをインデックス用に構造化
- **期待結果**: JSONからタイトルと本文が正しく抽出される

### 3.2 JSON形式ドキュメントの取得（階層構造）

- **前提条件**: タイトルや本文が階層構造のJSONに含まれている
- **トリガー**: 同期処理中にドキュメントを取得
- **処理フロー**:
    1. APIからJSONレスポンスを取得
    2. 設定されたパス（例: `data.article.title`）を辿ってフィールドを抽出
    3. 抽出したデータをインデックス用に構造化
- **期待結果**: ネストされた階層からタイトルと本文が正しく抽出される

### 3.3 HTML形式ドキュメントの取得

- **前提条件**: ドキュメントAPIがHTML形式でレスポンスを返す
- **トリガー**: 同期処理中にドキュメントを取得
- **処理フロー**:
    1. APIからHTMLレスポンスを取得
    2. 設定されたセレクタでタイトル・本文を抽出
    3. HTMLタグを除去してテキストを取得
    4. 抽出したデータをインデックス用に構造化
- **期待結果**: HTMLからタイトルと本文が正しく抽出される

### 3.4 プレーンテキスト形式ドキュメントの取得

- **前提条件**: ドキュメントAPIがプレーンテキスト形式でレスポンスを返す
- **トリガー**: 同期処理中にドキュメントを取得
- **処理フロー**:
    1. APIからテキストレスポンスを取得
    2. テキスト全体を本文として使用
    3. 抽出したデータをインデックス用に構造化
- **期待結果**: テキストが本文として正しく抽出される

### 3.5 不正な形式のドキュメント取得

- **前提条件**: ドキュメントの形式が設定と一致しない
- **トリガー**: 同期処理中にドキュメントを取得
- **処理フロー**:
    1. APIからレスポンスを取得
    2. パース処理でエラーが発生
    3. エラーをログに記録
    4. 該当ドキュメントをスキップして処理を継続
- **期待結果**: エラーが記録され、他のドキュメントは正常に処理される

## 4. LINE Bot連携シナリオ

### 4.1 Webhookイベント受信（正常系）

- **前提条件**: LINE Messaging APIの設定が正しい
- **トリガー**: LINEからWebhookイベントを受信
- **処理フロー**:
    1. Webhookリクエストを受信
    2. 署名を検証
    3. イベントを解析
    4. 適切な処理を実行
- **期待結果**: イベントが正しく処理される

### 4.2 Webhookイベント受信（署名検証エラー）

- **前提条件**: リクエストの署名が不正
- **トリガー**: Webhookリクエストを受信
- **処理フロー**:
    1. Webhookリクエストを受信
    2. 署名検証に失敗
    3. リクエストを拒否
- **期待結果**: 401/403エラーが返される

### 4.3 返信メッセージ送信エラー

- **前提条件**: LINE APIへの返信送信でエラーが発生
- **トリガー**: 回答メッセージを送信
- **処理フロー**:
    1. 回答を生成
    2. LINE APIへの送信に失敗
    3. エラーをログに記録
    4. リトライ処理を実行（必要に応じて）
- **期待結果**: エラーが記録され、リトライが試行される

### 4.4 長文回答の送信

- **前提条件**: 生成された回答がLINEのメッセージ長制限を超える
- **トリガー**: 長い回答を生成
- **処理フロー**:
    1. 回答を生成
    2. メッセージ長制限を超えていることを検知
    3. 回答を分割または要約
    4. 適切な形式で送信
- **期待結果**: 制限内に収まるよう調整された回答が送信される
